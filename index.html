<!doctype html> 
<html lang="en"> 
<head> 
    <meta charset="UTF-8" />
    <title>Making your first Phaser 3 Game - Part 10</title>
    <script src="phaser.min.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">
// Game utils
let cursors;
let canvasWidth = 800;
let canvasHeight = 600;

// Game objects
let player;
let stars;
let asteroids;
let starSpawner;
let asteroidSpawner;

// States
let gameOver = false;

let titleGameName;
let titleSubtext;
let scoreText;
let asteroidDebug;

// Score
let score = 0;

// Game config
let asteroidSpawnRate = 500;

let shipAngle = 270;
let shipTurnAngle = 25;
let shipSpeed = 350;


class TitleScene extends Phaser.Scene {

    constructor ()
    {
        super({
            key: 'TitleScene'
        })
    }

    preload ()
    {
        // SPRITES
        this.load.image('asteroid', 'assets/sprites/spr_asteroid_0.png');
        this.load.image('star', 'assets/sprites/spr_star_0.png');

        // AUDIO
        this.load.audio('titleMusic', 'assets/audio/snd_music_molten_alloy.mp3');
    }

    create ()
    {
        // Create UI elements
        titleGameName = this.add.text(canvasWidth/2, 
                                        canvasHeight/3, 
                                        'Asteroid Field', 
                                        { 
                                            fontSize: '56px', 
                                            fill: '#fff'
                                        }).setOrigin(0.5);

        titleSubtext = this.add.text(canvasWidth/2, 
                                        (canvasHeight/3)*2, 
                                        'for One Giant Leap gamejam', 
                                        { 
                                            fontSize: '26px', 
                                            fill: '#fff'
                                        }).setOrigin(0.5);

        titleGameName.depth = 10;
        titleSubtext.depth = 10;

        this.sound.add('titleMusic').play({loop: true});
    }
}


class GameScene extends Phaser.Scene {

    constructor ()
    {
        super({
            key: 'GameScene'
        })
    }

    preload ()
    {
        // SPRITES
        this.load.image('asteroid', 'assets/sprites/spr_asteroid_0.png');
        this.load.image('star', 'assets/sprites/spr_star_0.png');
        this.load.spritesheet('ship', 'assets/sprites/spr_ship.png', { frameWidth: 200, frameHeight: 100 });
        this.load.spritesheet('shipExplode', 'assets/sprites/spr_ship_explosion.png', { frameWidth: 384, frameHeight: 192 });

        // AUDIO
        this.load.audio('gameMusic', 'assets/audio/snd_music_thrashing_around.mp3');
        this.load.audio('shipEngine', 'assets/audio/snd_effect_engine.wav');
        this.load.audio('shipExplosion', 'assets/audio/snd_effect_explosion.wav');
        this.load.audio('bonus', 'assets/audio/snd_effect_bonus.wav');
    }

    create ()
    {
        //  Input Events
        cursors = this.input.keyboard.createCursorKeys();

        scoreText = this.add.text(16, 16, '', { fontSize: '32px', fill: '#fff' });
        scoreText.depth = 10;

        this.startGame(this);
    }

    setupPlayer(that)
    {
        // The player and its settings
        player = that.physics.add.sprite(400, 500, 'ship');
        player.angle = shipAngle;
        player.scale = 0.75;
        player.depth = 9;
        player.setSize(50, 130, true);
        player.body.setOffset(75, -30);
        player.allowGravity = false;
        player.setCollideWorldBounds(true);

        
        that.anims.create({
            key: 'shipDefault',
            frames: that.anims.generateFrameNumbers('ship', { start: 0, end: 1 }),
            frameRate: 10,
            repeat: -1
        });

        that.anims.create({
            key: 'shipExplode',
            frames: that.anims.generateFrameNumbers('shipExplode', { start: 0, end: 16 }),
            frameRate: 25,
            hideOnComplete: true
        });
    }


    startGame(that)
    {
        //  The score
        scoreText = that.add.text(16, 16, 'score: 0', { fontSize: '32px', fill: '#fff' });

        stars = that.physics.add.group();
        asteroids = that.physics.add.group();

        this.setupPlayer(that);

        starSpawner = that.time.addEvent({
            delay: 250,
            callback: this.spawnStars,
            callbackScope: that,
            loop: true
        });

        asteroidSpawner = that.time.addEvent({
            delay: asteroidSpawnRate,
            callback: this.spawnAsteroids,
            callbackScope: that,
            loop: true
        });

        that.time.addEvent({
            delay: 10000,
            callback: this.adjustAsteroidSpawnRate,
            callbackScope: that,
            loop: true
        });

        //scoreText.setText('Score: 0');
        //asteroidDebug.setText('spawnRate: ' + asteroidSpawner.delay);
    }

    adjustAsteroidSpawnRate()
    {
        if (asteroidSpawner.delay > 100) {
            asteroidSpawner.delay = asteroidSpawner.delay - 75;
        }
    }

    endGame()
    {
        if(!gameOver) {
            console.log("hitAsteroid");
            starSpawner.destroy();
            asteroidSpawner.destroy();
            this.destroyAllObjects();
            gameOver = true;
            player.anims.play('shipExplode');
            scoreText.setText('');
        }
    }

    update ()
    {
        if (gameOver)
        {
            return;
        }

        score += 1;
        scoreText.setText('Score: ' + score);

        player.anims.play('shipDefault', true);

        if (cursors.left.isDown)
        {
            player.setVelocityX(-shipSpeed);
            player.angle = shipAngle - shipTurnAngle;
        }
        else if (cursors.right.isDown)
        {
            player.setVelocityX(shipSpeed);
            player.angle = shipAngle + shipTurnAngle;
        }
        else
        {
            player.setVelocityX(0);
            player.angle = shipAngle;
        }
    }


    spawnStars ()
    {
        stars = this.physics.add.group({
            key: 'star',
            setXY: { x: Math.random() * (canvasWidth - 0) + 0, y: 0 }
        });

        stars.children.iterate(function (star) {
            star.angle = 270;
            star.depth = 1;
            star.setVelocityY(750);
        });

        this.destroyOffscreenObjects();
    }


    spawnAsteroids ()
    {
        let scaleMin = 0.5;
        let scaleMax = 1;
        let velocityMin = 200;
        let velocityMax = 500;
        let rotationMin = 10;
        let rotationMax = 500;

        asteroids = this.physics.add.group({
            key: 'asteroid',
            setXY: { x: Math.random() * (canvasWidth - 0) + 0, y: 0 }
        });

        asteroids.children.iterate(function (asteroid) {
            asteroid.depth = 2;
            asteroid.scale = Math.random() * (scaleMax - scaleMin) + scaleMin;
            asteroid.setVelocityY(Math.random() * (velocityMax - velocityMin) + velocityMin);
            asteroid.setAngularVelocity(Math.random() * (rotationMax - rotationMin) + rotationMin);
        });

        this.physics.add.collider(player, asteroids, this.hitAsteroid, null, this);
    }

    destroyOffscreenObjects ()
    {
        stars.children.iterate(function (star) {
            if(star.y > canvasHeight) {
                star.destroy();
            }
        });

        asteroids.children.iterate(function (asteroid) {
            if(asteroid.y > canvasHeight) {
                asteroid.destroy();
            }
        });
    }

    destroyAllObjects ()
    {
        stars.children.iterate(function (star) {
            star.destroy();
        });

        asteroids.children.iterate(function (asteroid) {
            asteroid.destroy();
        });
    }

    hitAsteroid (player, asteroid)
    {
        this.endGame();
    }
}

let config = {
    type: Phaser.AUTO,
    width: canvasWidth,
    height: canvasHeight,
    physics: {
        default: 'arcade',
        arcade: {
            debug: false,
            debugShowBody: true,
            debugBodyColor: 0x00ff00,
        }
    },
    audio: {
        disableWebAudio: true
    },
    scene: [
        GameScene,
        TitleScene,
    ]
    //scene: {
        // preload: preload,
        // create: create,
        // update: update
    //}
};

let game = new Phaser.Game(config);

</script>

</body>
</html>