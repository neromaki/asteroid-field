<!doctype html> 
<html lang="en"> 
<head> 
    <meta charset="UTF-8" />
    <title>Making your first Phaser 3 Game - Part 10</title>
    <script src="phaser.min.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">
// Game utils
let cursors;
let canvasWidth = 800;
let canvasHeight = 600;

// Game objects
let player;
let stars;
let asteroids;
let starSpawner;
let asteroidSpawner;

// States
let gameOver = false;
let gameRunning = false;

// UI
let scoreText;
let asteroidDebug;

// Score
let score = 0;

// Game config
let asteroidSpawnRate = 500;

let config = {
    type: Phaser.AUTO,
    width: canvasWidth,
    height: canvasHeight,
    physics: {
        default: 'arcade',
        arcade: {
            debug: false,
            debugShowBody: true,
            debugBodyColor: 0x00ff00,
        }
    },
    audio: {
        disableWebAudio: true
    },
    scene: {
        preload: preload,
        create: create,
        update: update
    }
};

let game = new Phaser.Game(config);

function preload ()
{
    //this.load.image('star', 'assets/spr_star_0.png');
    this.load.image('asteroid', 'assets/spr_asteroid_0.png');
    this.load.image('star', 'assets/spr_star_0.png');
    this.load.spritesheet('ship', 'assets/spr_ship.png', { frameWidth: 200, frameHeight: 100 });
    this.load.spritesheet('shipExplode', 'assets/spr_ship_explosion.png', { frameWidth: 384, frameHeight: 192 });
}

function create ()
{
    //  Input Events
    cursors = this.input.keyboard.createCursorKeys();

    //  The score
    scoreText = this.add.text(16, 16, 'score: 0', { fontSize: '32px', fill: '#fff' });
    asteroidDebug = this.add.text(16, 60, 'spawnRate', { fontSize: '16px', fill: '#fff' });

    stars = this.physics.add.group();
    asteroids = this.physics.add.group();

    setupPlayer(this);
    startGame(this);
}

function setupPlayer(that)
{
    // The player and its settings
    player = that.physics.add.sprite(400, 500, 'ship');
    player.angle = shipAngle;
    player.scale = 0.75;
    player.setSize(50, 130, true);
    player.body.setOffset(75, -30);
    player.allowGravity = false;
    player.setCollideWorldBounds(true);

    
    that.anims.create({
        key: 'shipDefault',
        frames: that.anims.generateFrameNumbers('ship', { start: 0, end: 1 }),
        frameRate: 10,
        repeat: -1
    });

    that.anims.create({
        key: 'shipExplode',
        frames: that.anims.generateFrameNumbers('shipExplode', { start: 0, end: 16 }),
        frameRate: 25,
        hideOnComplete: true
    });
}

function startGame(that)
{   
    starSpawner = that.time.addEvent({
        delay: 350,
        callback: spawnStars,
        callbackScope: that,
        loop: true
    });

    asteroidSpawner = that.time.addEvent({
        delay: asteroidSpawnRate,
        callback: spawnAsteroids,
        callbackScope: that,
        loop: true
    });

    that.time.addEvent({
        delay: 10000,
        callback: adjustAsteroidSpawnRate,
        callbackScope: that,
        loop: true
    });

    scoreText.setText('Score: 0');
    asteroidDebug.setText('spawnRate: ' + asteroidSpawner.delay);
}

function adjustAsteroidSpawnRate()
{
    if (asteroidSpawner.delay > 100) {
        asteroidSpawner.delay = asteroidSpawner.delay - 75;
        asteroidDebug.setText('spawnRate: ' + asteroidSpawner.delay);
    }
}

function endGame()
{
    if(!gameOver) {
        console.log("hitAsteroid");
        starSpawner.destroy();
        asteroidSpawner.destroy();
        destroyAllObjects();
        gameOver = true;
        player.anims.play('shipExplode');
        scoreText.setText('');
    }
}


let shipAngle = 270;
let shipTurnAngle = 25;
let shipSpeed = 350;

function update ()
{
    if (gameOver)
    {
        return;
    }

    score += 1;
    scoreText.setText('Score: ' + score);

    player.anims.play('shipDefault', true);

    if (cursors.left.isDown)
    {
        player.setVelocityX(-shipSpeed);
        player.angle = shipAngle - shipTurnAngle;
    }
    else if (cursors.right.isDown)
    {
        player.setVelocityX(shipSpeed);
        player.angle = shipAngle + shipTurnAngle;
    }
    else
    {
        player.setVelocityX(0);
        player.angle = shipAngle;
    }
}


function spawnStars ()
{
    stars = this.physics.add.group({
        key: 'star',
        setXY: { x: Math.random() * (canvasWidth - 0) + 0, y: 0 }
    });

    stars.children.iterate(function (star) {
        star.angle = 270;
        star.setVelocityY(750);
    });

    destroyOffscreenObjects();
}


function spawnAsteroids ()
{
    let scaleMin = 0.5;
    let scaleMax = 1;
    let velocityMin = 200;
    let velocityMax = 500;
    let rotationMin = 10;
    let rotationMax = 500;

    // let asteroid = asteroids.create(Math.random() * (canvasWidth - 0) + 0, 0, 'asteroid');

    // asteroid.scale = Math.random() * (scaleMax - scaleMin) + scaleMin;
    // asteroid.setVelocityY(Math.random() * (velocityMax - velocityMin) + velocityMin);
    // asteroid.setAngularVelocity(Math.random() * (rotationMax - rotationMin) + rotationMin);

    asteroids = this.physics.add.group({
        key: 'asteroid',
        setXY: { x: Math.random() * (canvasWidth - 0) + 0, y: 0 }
    });

    asteroids.children.iterate(function (asteroid) {
        asteroid.scale = Math.random() * (scaleMax - scaleMin) + scaleMin;
        asteroid.setVelocityY(Math.random() * (velocityMax - velocityMin) + velocityMin);
        asteroid.setAngularVelocity(Math.random() * (rotationMax - rotationMin) + rotationMin);
    });

    this.physics.add.collider(player, asteroids, hitAsteroid, null, this);
}

function destroyOffscreenObjects ()
{
    stars.children.iterate(function (star) {
        if(star.y > canvasHeight) {
            star.destroy();
        }
    });

    asteroids.children.iterate(function (asteroid) {
        if(asteroid.y > canvasHeight) {
            asteroid.destroy();
        }
    });
}

function destroyAllObjects ()
{
    stars.children.iterate(function (star) {
        star.destroy();
    });

    asteroids.children.iterate(function (asteroid) {
        asteroid.destroy();
    });
}

function hitAsteroid (player, asteroid)
{
    endGame();
}

</script>

</body>
</html>