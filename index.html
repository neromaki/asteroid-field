<!doctype html> 
<html lang="en"> 
<head> 
    <meta charset="UTF-8" />
    <title>Making your first Phaser 3 Game - Part 10</title>
    <script src="phaser.min.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">
/**
*   TODO:
*   Transitioning from TITLE to GAME a second time causes startGame() to be called twice?!
*   Spawned ASTEROIDS and STARS don't have a Y value??
*/

// Game utilities;
let cursors;
let canvasWidth = 800;
let canvasHeight = 600;

// Game objects
let player, stars, asteroids, starSpawner, asteroidSpawner;

// States
let gameOver = false;
let resetTimer;

// UI
let titleGameName, titleSubtext, titleInstructions, scoreDisplay, scoreLabel, gameOverText, finalScore, finalScoreLabel, gameOverRestart;

// Score
let score = 0;

// Game config
let asteroidSpawnRate = 500;

let shipAngle = 270;
let shipTurnAngle = 25;
let shipSpeed = 350;

let idleTimeToReset = 5000;


/**
*   The title screen
*/
class TitleScene extends Phaser.Scene {

    constructor ()
    {
        super({
            key: 'TitleScene'
        });

        this.music;
    }

    preload ()
    {
        // SPRITES
        this.load.image('asteroid', 'assets/sprites/spr_asteroid_0.png');
        this.load.image('star', 'assets/sprites/spr_star_0.png');

        // AUDIO
        this.load.audio('titleMusic', 'assets/audio/snd_music_molten_alloy.mp3');
    }

    create ()
    {
        console.log("SCENE: Title");
        //this.input.keyboard.enabled = true;

        if(resetTimer) {
            resetTimer.destroy();
        }

        // Input Events
        cursors = this.input.keyboard.createCursorKeys();

        // Create UI elements
        titleGameName = this.add.text(canvasWidth/2, 
                                        canvasHeight/3, 
                                        'Asteroid Field', 
                                        { 
                                            fontSize: '56px', 
                                            fill: '#fff'
                                        }).setOrigin(0.5);

        titleSubtext = this.add.text(canvasWidth/2, 
                                        (canvasHeight/3) + 50, 
                                        'a game for One Giant Leap',
                                        { 
                                            fontSize: '16px', 
                                            fill: '#fff'
                                        }).setOrigin(0.5);



        titleInstructions = this.add.text(canvasWidth/2, 
                                        (canvasHeight/3) * 2, 
                                        'press any button to start',
                                        { 
                                            fontSize: '24px', 
                                            fill: '#fff'
                                        }).setOrigin(0.5);

        titleGameName.depth = 10;
        titleSubtext.depth = 10;
        titleInstructions.depth = 10;

        this.music = this.sound.add('titleMusic');
        this.music.play({loop: true});
    }

    update ()
    {
        if (cursors.left.isDown || cursors.right.isDown) {
            this.music.stop();
            this.scene.start('GameScene');
        }
    }
}


class GameScene extends Phaser.Scene {

    constructor ()
    {
        super({
            key: 'GameScene'
        });

        this.music;
    }

    preload ()
    {
        // SPRITES
        this.load.image('asteroid', 'assets/sprites/spr_asteroid_0.png');
        this.load.image('star', 'assets/sprites/spr_star_0.png');
        this.load.spritesheet('ship', 'assets/sprites/spr_ship.png', { frameWidth: 200, frameHeight: 100 });
        this.load.spritesheet('shipExplode', 'assets/sprites/spr_ship_explosion.png', { frameWidth: 384, frameHeight: 192 });

        // AUDIO
        this.load.audio('gameMusic', 'assets/audio/snd_music_thrashing_around.mp3');
        this.load.audio('shipEngine', 'assets/audio/snd_effect_engine.wav');
        this.load.audio('shipExplosion', 'assets/audio/snd_effect_explosion.wav');
        this.load.audio('bonus', 'assets/audio/snd_effect_bonus.wav');
    }


    /*
    * Setup UI elements and score
    */
    create ()
    {
        console.log("SCENE: Game");

        // Input Events
        cursors = this.input.keyboard.createCursorKeys();
        console.log(cursors);
        //this.input.keyboard.enabled = true;
        
        scoreLabel = this.add.text(32, 22, 'Score:', { fontSize: '18px', fill: '#fff' });
        scoreLabel.depth = 10;

        scoreDisplay = this.add.text(110, 16, '', { fontSize: '32px', fill: '#fff', align: 'left' });

        // Create UI elements
        gameOverText = this.add.text(canvasWidth/2, 
                                        (canvasHeight/3)-50, 
                                        'GAME OVER', 
                                        { 
                                            fontSize: '56px', 
                                            fill: '#fff'
                                        }).setOrigin(0.5).setVisible(false);


        finalScoreLabel = this.add.text(canvasWidth/2, 
                                        (canvasHeight/3) + 50, 
                                        'Your score:',
                                        { 
                                            fontSize: '16px', 
                                            fill: '#fff'
                                        }).setOrigin(0.5).setVisible(false);

        finalScore = this.add.text(canvasWidth/2, 
                                        (canvasHeight/3) + 100, 
                                        '',
                                        { 
                                            fontSize: '42px', 
                                            fill: '#fff'
                                        }).setOrigin(0.5).setVisible(false);



        gameOverRestart = this.add.text(canvasWidth/2, 
                                        (canvasHeight/3) * 2, 
                                        'Press any button to try again',
                                        { 
                                            fontSize: '24px', 
                                            fill: '#fff'
                                        }).setOrigin(0.5).setVisible(false);

        this.music = this.sound.add('gameMusic');

        this.startGame(this);
    }


    /*
    *   Create and set up the player sprite, animations etc
    */
    setupPlayer(that)
    {
        // The player and its settings
        player = that.physics.add.sprite(400, 500, 'ship');
        player.angle = shipAngle;
        player.scale = 0.75;
        player.depth = 9;
        player.setSize(50, 130, true);
        player.body.setOffset(75, -30);
        player.allowGravity = false;
        player.setCollideWorldBounds(true);

        that.anims.create({
            key: 'shipDefault',
            frames: that.anims.generateFrameNumbers('ship', { start: 0, end: 1 }),
            frameRate: 10,
            repeat: -1
        });

        that.anims.create({
            key: 'shipExplode',
            frames: that.anims.generateFrameNumbers('shipExplode', { start: 0, end: 16 }),
            frameRate: 25,
            hideOnComplete: true
        });
    }


    /*
    * Setup the player, kick off the STAR and ASTEROID spawners
    * and show the right UI elements
    */
    startGame(that)
    {
        console.log("GAME: startGame()");

        if(resetTimer) {
            resetTimer.destroy();
        }

        cursors.left.reset();
        cursors.right.reset();

        this.music.play({loop: true});
        
        stars = that.physics.add.group();
        asteroids = that.physics.add.group();

        this.setupPlayer(that);

        // Start spawning background stars
        starSpawner = that.time.addEvent({
            delay: 250,
            callback: this.spawnStars,
            callbackScope: that,
            loop: true
        });

        // Start spawning asteroids
        asteroidSpawner = that.time.addEvent({
            delay: asteroidSpawnRate,
            callback: this.spawnAsteroids,
            callbackScope: that,
            loop: true
        });

        // Increase the asteroid spawn rate every X seconds
        that.time.addEvent({
            delay: 10000,
            callback: this.adjustAsteroidSpawnRate,
            callbackScope: that,
            loop: true
        });

        // Initialise score
        score = 0;

        // Display the right UI
        scoreDisplay.setVisible(true);
        scoreLabel.setVisible(true);

        gameOverText.setVisible(false);
        finalScore.setVisible(false);
        finalScoreLabel.setVisible(false);
        gameOverRestart.setVisible(false);
    }


    update ()
    {
        // If the game is over, test whether the player is pressing either L or R
        // if so, start the game again
        if (gameOver)
        {
            if (cursors.left.getDuration() > 0 && cursors.left.getDuration() < 100 
            || cursors.right.getDuration() > 0 && cursors.right.getDuration() < 100 ) {
                gameOver = false;
                this.music.stop();
                this.startGame(this);
            }
            return false;
        }

        // Increment the score and update the in-game and game over score UI
        score += 1;
        scoreDisplay.setText(score);
        finalScore.setText(score);

        // Keep playing the default player animation
        player.anims.play('shipDefault', true);

        // Move the player left
        if (cursors.left.isDown)
        {
            player.setVelocityX(-shipSpeed);
            player.angle = shipAngle - shipTurnAngle;
        }
        // Move the player right
        else if (cursors.right.isDown)
        {
            player.setVelocityX(shipSpeed);
            player.angle = shipAngle + shipTurnAngle;
        }
        // Return to idle forward position
        else
        {
            player.setVelocityX(0);
            player.angle = shipAngle;
        }
    }


    /*
    * Spawn stars to serve as background decoration
    */
    spawnStars ()
    {
        // Add a new star to the physics group at a random X coordinate
        stars = this.physics.add.group({
            key: 'star',
            setXY: { x: Math.random() * (canvasWidth - 0) + 0, y: 0 }
        });

        // Point it downwards and fling it
        stars.children.iterate(function (star) {
            star.angle = 270;
            star.depth = 1;
            star.setVelocityY(750);
        });

        // Destroy offscreen objects
        this.destroyOffscreenObjects();
    }


    /*
    * Spawn asteroids which the player must avoid
    */
    spawnAsteroids ()
    {
        // Asteroid config
        let scaleMin = 0.5;
        let scaleMax = 1;
        let velocityMin = 200;
        let velocityMax = 500;
        let rotationMin = 10;
        let rotationMax = 500;

        asteroids = this.physics.add.group({
            key: 'asteroid',
            setXY: { x: Math.random() * (canvasWidth - 0) + 0, y: 0 }
        });

        asteroids.children.iterate(function (asteroid) {
            asteroid.depth = 2;
            asteroid.scale = Math.random() * (scaleMax - scaleMin) + scaleMin;
            asteroid.setVelocityY(Math.random() * (velocityMax - velocityMin) + velocityMin);
            asteroid.setAngularVelocity(Math.random() * (rotationMax - rotationMin) + rotationMin);
        });

        this.physics.add.collider(player, asteroids, this.hitAsteroid, null, this);
    }


    /*
    * Adjust the asteroid spawn rate by X each time, to a minimum of 100ms
    */
    adjustAsteroidSpawnRate()
    {
        if (asteroidSpawner.delay > 100) {
            asteroidSpawner.delay = asteroidSpawner.delay - 75;
        }
    }


    /*
    * End the game and display the GAME OVER screen with final score
    */
    endGame(that)
    {
        if(!gameOver) {
            console.log("GAME: endGame()");
            gameOver = true;

            // Explode the player
            player.anims.play('shipExplode');
            player.on('animationcomplete', function() {
                player.destroy();
            }, this);
            this.sound.play('shipExplosion');

            // Stop spawning stars and asteroids
            starSpawner.destroy();
            asteroidSpawner.destroy();

            // Remove all star and asteroid game objects
            this.destroyAllObjects();

            // Display the game over UI
            scoreDisplay.setVisible(false);
            scoreLabel.setVisible(false);

            gameOverText.setVisible(true);
            finalScore.setVisible(true);
            finalScoreLabel.setVisible(true);
            gameOverRestart.setVisible(true);

            // Disable the input for X seconds to prevent immediate restart
            cursors.left.enabled = false;
            cursors.right.enabled = false;

            that.time.addEvent({
                delay: 1000,
                callback: function() {
                    cursors.left.enabled = true;
                    cursors.right.enabled = true;
                }
            });

            // Start the reset timer which - if reached - will return to the title screen
            resetTimer = that.time.addEvent({
                delay: idleTimeToReset,
                callback: function() {
                    console.log("GAME: Returning to title");
                    this.music.stop();
                    this.scene.start('TitleScene');
                },
                callbackScope: that
            });
        }
    }


    /*
    * Destroy any stars or asteroids which are off-screen
    */
    destroyOffscreenObjects ()
    {
        // Destroy off-screen stars
        stars.children.iterate(function (star) {
            if(star.y > canvasHeight) {
                star.destroy();
                console.log("DESTROYING STAR");
            }
        });

        // Destroy off-screen asteroids
        asteroids.children.iterate(function (asteroid) {
            if(asteroid.y > canvasHeight) {
                asteroid.destroy();
                console.log("DESTROYING ASTEROID");
            }
        });
    }


    /*
    * Destroy all stars or asteroids
    */
    destroyAllObjects ()
    {
        console.log("GAME: Destroying all STARS");
        stars.children.iterate(function (star) {
            star.destroy();
        });

        console.log("GAME: Destroying all ASTEROIDS");
        asteroids.children.iterate(function (asteroid) {
            asteroid.destroy();
        });
    }


    /*
    * If the player hits an asteroid, GAME OVER, FRIEND
    */
    hitAsteroid (player, asteroid)
    {
        this.endGame(this);
    }
}


// Phaser config
let config = {
    type: Phaser.AUTO,
    width: canvasWidth,
    height: canvasHeight,
    physics: {
        default: 'arcade',
        arcade: {
            debug: true,
            debugShowBody: true,
            debugBodyColor: 0x00ff00,
        }
    },
    audio: {
        disableWebAudio: true
    },
    scene: [
        TitleScene,
        GameScene,
    ]
    //scene: {
        // preload: preload,
        // create: create,
        // update: update
    //}
};

// Lets get this party started!
let game = new Phaser.Game(config);

</script>

</body>
</html>